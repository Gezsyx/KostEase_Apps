/*
 * Click nbfs://nbhost/SystemFileSystem/Templates/Licenses/license-default.txt to change this license
 * Click nbfs://nbhost/SystemFileSystem/Templates/GUIForms/JPanel.java to edit this template
 */
package panels;

import java.sql.Connection;
import java.sql.ResultSet;
import java.sql.Statement;
import javax.swing.JOptionPane;
import util.Koneksi;

/**
 *
 * @author ASUS
 */
public class GrafikPenjualan extends javax.swing.JPanel {

    /**
     * Creates new form GrafikPenjualan
     */
    public GrafikPenjualan() {
        initComponents();
        grafikPanel.add(canvas, java.awt.BorderLayout.CENTER); // Pasang canvas ke panel
        setFilterToCurrentDate();
        updateGrafik();
    }

    CanvasGrafik canvas = new CanvasGrafik();

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jPanel1 = new javax.swing.JPanel();
        jLabel1 = new javax.swing.JLabel();
        jLabel2 = new javax.swing.JLabel();
        laporan = new javax.swing.JComboBox<>();
        filterBulan = new javax.swing.JComboBox<>();
        jLabel7 = new javax.swing.JLabel();
        filterTanggal = new javax.swing.JComboBox<>();
        jLabel8 = new javax.swing.JLabel();
        jLabel6 = new javax.swing.JLabel();
        filterTahun = new javax.swing.JComboBox<>();
        grafikPanel = new javax.swing.JPanel();

        setLayout(new java.awt.BorderLayout());

        jPanel1.setBackground(new java.awt.Color(255, 255, 255));

        jLabel1.setFont(new java.awt.Font("Roboto", 3, 18)); // NOI18N
        jLabel1.setText("GRAFIK ANALITIK");

        jLabel2.setFont(new java.awt.Font("Roboto", 0, 18)); // NOI18N
        jLabel2.setText("LAPORAN  :");

        laporan.setFont(new java.awt.Font("Roboto", 0, 18)); // NOI18N
        laporan.setModel(new javax.swing.DefaultComboBoxModel<>(new String[] { "KINERJA KASIR", "PENJUALAN KAMAR", " " }));
        laporan.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                laporanActionPerformed(evt);
            }
        });

        filterBulan.setFont(new java.awt.Font("Roboto", 0, 18)); // NOI18N
        filterBulan.setModel(new javax.swing.DefaultComboBoxModel<>(new String[] { "SEMUA", "1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12" }));
        filterBulan.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                filterBulanActionPerformed(evt);
            }
        });

        jLabel7.setFont(new java.awt.Font("Roboto", 0, 18)); // NOI18N
        jLabel7.setText("BULAN   :");

        filterTanggal.setFont(new java.awt.Font("Roboto", 0, 18)); // NOI18N
        filterTanggal.setModel(new javax.swing.DefaultComboBoxModel<>(new String[] { "SEMUA", "1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12", "13", "14", "15", "16", "17", "18", "19", "20", "21", "22", "23", "24", "25", "26", "27", "28", "29", "30", "31" }));
        filterTanggal.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                filterTanggalActionPerformed(evt);
            }
        });

        jLabel8.setFont(new java.awt.Font("Roboto", 0, 18)); // NOI18N
        jLabel8.setText("TANGGAL   :");

        jLabel6.setFont(new java.awt.Font("Roboto", 0, 18)); // NOI18N
        jLabel6.setText("TAHUN   :");

        filterTahun.setFont(new java.awt.Font("Roboto", 0, 18)); // NOI18N
        filterTahun.setModel(new javax.swing.DefaultComboBoxModel<>(new String[] { "SEMUA", "2025", "2026" }));
        filterTahun.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                filterTahunActionPerformed(evt);
            }
        });

        grafikPanel.setLayout(new java.awt.BorderLayout());

        javax.swing.GroupLayout jPanel1Layout = new javax.swing.GroupLayout(jPanel1);
        jPanel1.setLayout(jPanel1Layout);
        jPanel1Layout.setHorizontalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel1Layout.createSequentialGroup()
                .addGap(34, 34, 34)
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(jLabel1, javax.swing.GroupLayout.PREFERRED_SIZE, 194, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addGroup(jPanel1Layout.createSequentialGroup()
                        .addComponent(jLabel2)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                        .addComponent(laporan, javax.swing.GroupLayout.PREFERRED_SIZE, 190, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addGap(33, 33, 33)
                        .addComponent(jLabel8, javax.swing.GroupLayout.PREFERRED_SIZE, 110, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addGap(10, 10, 10)
                        .addComponent(filterTanggal, javax.swing.GroupLayout.PREFERRED_SIZE, 110, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addGap(29, 29, 29)
                        .addComponent(jLabel7, javax.swing.GroupLayout.PREFERRED_SIZE, 96, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addGap(4, 4, 4)
                        .addComponent(filterBulan, javax.swing.GroupLayout.PREFERRED_SIZE, 110, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addGap(30, 30, 30)
                        .addComponent(jLabel6, javax.swing.GroupLayout.PREFERRED_SIZE, 89, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addGap(11, 11, 11)
                        .addComponent(filterTahun, javax.swing.GroupLayout.PREFERRED_SIZE, 110, javax.swing.GroupLayout.PREFERRED_SIZE))
                    .addComponent(grafikPanel, javax.swing.GroupLayout.PREFERRED_SIZE, 1500, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );
        jPanel1Layout.setVerticalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel1Layout.createSequentialGroup()
                .addGap(26, 26, 26)
                .addComponent(jLabel1)
                .addGap(42, 42, 42)
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(filterTanggal, javax.swing.GroupLayout.PREFERRED_SIZE, 40, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(jLabel7, javax.swing.GroupLayout.PREFERRED_SIZE, 35, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(filterBulan, javax.swing.GroupLayout.PREFERRED_SIZE, 40, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(jLabel6, javax.swing.GroupLayout.PREFERRED_SIZE, 35, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(filterTahun, javax.swing.GroupLayout.PREFERRED_SIZE, 40, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING, false)
                        .addComponent(jLabel2, javax.swing.GroupLayout.Alignment.LEADING, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                        .addComponent(laporan, javax.swing.GroupLayout.Alignment.LEADING, javax.swing.GroupLayout.DEFAULT_SIZE, 35, Short.MAX_VALUE)
                        .addComponent(jLabel8, javax.swing.GroupLayout.Alignment.LEADING, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)))
                .addGap(46, 46, 46)
                .addComponent(grafikPanel, javax.swing.GroupLayout.PREFERRED_SIZE, 561, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );

        add(jPanel1, java.awt.BorderLayout.CENTER);
    }// </editor-fold>//GEN-END:initComponents

    private void filterBulanActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_filterBulanActionPerformed
        updateTanggalCombo();
        updateGrafik();
        // TODO add your handling code here:
    }//GEN-LAST:event_filterBulanActionPerformed

    private void filterTanggalActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_filterTanggalActionPerformed
        updateGrafik();
        // TODO add your handling code here:
    }//GEN-LAST:event_filterTanggalActionPerformed

    private void filterTahunActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_filterTahunActionPerformed
        updateTanggalCombo();
        updateGrafik();
        // TODO add your handling code here:
    }//GEN-LAST:event_filterTahunActionPerformed

    private void laporanActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_laporanActionPerformed
        updateGrafik();
        // TODO add your handling code here:
    }//GEN-LAST:event_laporanActionPerformed


    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JComboBox<String> filterBulan;
    private javax.swing.JComboBox<String> filterTahun;
    private javax.swing.JComboBox<String> filterTanggal;
    private javax.swing.JPanel grafikPanel;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JLabel jLabel6;
    private javax.swing.JLabel jLabel7;
    private javax.swing.JLabel jLabel8;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JComboBox<String> laporan;
    // End of variables declaration//GEN-END:variables

    private void setFilterToCurrentDate() {
        java.util.Calendar cal = java.util.Calendar.getInstance();
        int tgl = cal.get(java.util.Calendar.DAY_OF_MONTH);
        int bln = cal.get(java.util.Calendar.MONTH) + 1; 
        int thn = cal.get(java.util.Calendar.YEAR);

        updateTanggalCombo();

        filterTanggal.setSelectedItem(String.valueOf(tgl));
        filterBulan.setSelectedItem(String.valueOf(bln));
        filterTahun.setSelectedItem(String.valueOf(thn));
    }

    private void updateTanggalCombo() {

        Object selBulan = filterBulan.getSelectedItem();
        Object selTahun = filterTahun.getSelectedItem();

        if (selBulan == null || selTahun == null) {
            return;
        }

        String selectedBulan = selBulan.toString();
        String selectedTahun = selTahun.toString();
        Object currentTgl = filterTanggal.getSelectedItem();

        if (selectedBulan.equals("SEMUA") || selectedTahun.equals("SEMUA")) {
         
            return;
        }

        int bulan = Integer.parseInt(selectedBulan);
        int tahun = Integer.parseInt(selectedTahun);

        java.util.Calendar cal = new java.util.GregorianCalendar(tahun, bulan - 1, 1);
        int daysInMonth = cal.getActualMaximum(java.util.Calendar.DAY_OF_MONTH);

        filterTanggal.removeActionListener(filterTanggal.getActionListeners()[0]);

        filterTanggal.removeAllItems();
        filterTanggal.addItem("SEMUA");
        for (int i = 1; i <= daysInMonth; i++) {
            filterTanggal.addItem(String.valueOf(i));
        }

        filterTanggal.setSelectedItem(currentTgl);

        filterTanggal.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                filterTanggalActionPerformed(evt);
            }
        });

    }

    class CanvasGrafik extends javax.swing.JPanel {

        private String[] labels;
        private int[] values;
        private String judul;

        public void setData(String[] labels, int[] values, String judul) {
            this.labels = labels;
            this.values = values;
            this.judul = judul;
            repaint(); 
        }

        @Override
        protected void paintComponent(java.awt.Graphics g) {
            super.paintComponent(g);
            if (labels == null || labels.length == 0) {
                return;
            }

            java.awt.Graphics2D g2 = (java.awt.Graphics2D) g;
            g2.setRenderingHint(java.awt.RenderingHints.KEY_ANTIALIASING, java.awt.RenderingHints.VALUE_ANTIALIAS_ON);

            int padding = 50;
            int width = getWidth() - (2 * padding);
            int height = getHeight() - (2 * padding);

            int maxVal = 0;
            for (int v : values) {
                if (v > maxVal) {
                    maxVal = v;
                }
            }
            if (maxVal == 0) {
                maxVal = 1;
            }

            g2.setFont(new java.awt.Font("Arial", java.awt.Font.BOLD, 14));
            g2.drawString(judul, padding, padding / 2);

            g2.drawLine(padding, height + padding, width + padding, height + padding); 
            g2.drawLine(padding, padding, padding, height + padding); 

            int barWidth = width / labels.length - 20;

            for (int i = 0; i < labels.length; i++) {
   
                int barHeight = (int) ((double) values[i] / maxVal * height);
                int x = padding + (i * (width / labels.length)) + 10;
                int y = height + padding - barHeight;

                g2.setColor(new java.awt.Color(52, 152, 219));
                g2.fillRect(x, y, barWidth, barHeight);
                g2.setColor(java.awt.Color.BLACK);
                g2.drawRect(x, y, barWidth, barHeight);

                g2.setFont(new java.awt.Font("Arial", java.awt.Font.PLAIN, 10));
                g2.drawString(labels[i], x, height + padding + 15);

                g2.drawString(String.valueOf(values[i]), x + (barWidth / 4), y - 5);
            }
        }
    }

    private void updateGrafik() {
        String tipeLaporan = (String) laporan.getSelectedItem();
        String tgl = (String) filterTanggal.getSelectedItem();
        String bln = (String) filterBulan.getSelectedItem();
        String thn = (String) filterTahun.getSelectedItem();

        String whereClause = " WHERE 1=1 ";
        if (!tgl.equals("SEMUA")) {
            whereClause += " AND DAY(p.tanggal) = " + tgl;
        }
        if (!bln.equals("SEMUA")) {
            whereClause += " AND MONTH(p.tanggal) = " + bln;
        }
        if (!thn.equals("SEMUA")) {
            whereClause += " AND YEAR(p.tanggal) = " + thn;
        }

        String query = "";
        String columnLabel = "";
        String judulGrafik = "";

        if (tipeLaporan.equals("KINERJA KASIR")) {
            query = "SELECT pg.nama as label, COUNT(p.id_pembayaran) as jumlah "
                    + "FROM pembayaran p JOIN pegawai pg ON p.id_pegawai = pg.id_pegawai "
                    + whereClause + " GROUP BY pg.nama";
            judulGrafik = "Jumlah Transaksi Per Kasir";
        } else {
            query = "SELECT k.tipe_kamar as label, COUNT(dp.id_kamar) as jumlah "
                    + "FROM detail_pembayaran dp "
                    + "JOIN pembayaran p ON dp.id_pembayaran = p.id_pembayaran "
                    + "JOIN kamar k ON dp.id_kamar = k.id_kamar "
                    + whereClause + " GROUP BY k.tipe_kamar";
            judulGrafik = "Penjualan Berdasarkan Tipe Kamar";
        }

        try (Connection conn = util.Koneksi.Colok(); Statement st = conn.createStatement(); ResultSet rs = st.executeQuery(query)) {

            java.util.List<String> labels = new java.util.ArrayList<>();
            java.util.List<Integer> values = new java.util.ArrayList<>();

            while (rs.next()) {
                labels.add(rs.getString("label"));
                values.add(rs.getInt("jumlah"));
            }
            canvas.setData(labels.toArray(new String[0]),
                    values.stream().mapToInt(i -> i).toArray(),
                    judulGrafik);

        } catch (Exception e) {
            e.printStackTrace();
        }
    }

}
